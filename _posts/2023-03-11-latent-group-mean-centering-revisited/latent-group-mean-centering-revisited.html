<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
  <title>Latent group means with brms</title>

  <meta property="description" itemprop="description" content="Richard McElreath recently shared a tutorial on how to do estimate latent group means (à la Mundlak) in Stan. I try to follow his code, do the same with brms, and try to implement a solution Matti Vuorre posted."/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2023-03-15"/>
  <meta property="article:created" itemprop="dateCreated" content="2023-03-15"/>
  <meta name="article:author" content="Ruben C. Arslan"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Latent group means with brms"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Richard McElreath recently shared a tutorial on how to do estimate latent group means (à la Mundlak) in Stan. I try to follow his code, do the same with brms, and try to implement a solution Matti Vuorre posted."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Latent group means with brms"/>
  <meta property="twitter:description" content="Richard McElreath recently shared a tutorial on how to do estimate latent group means (à la Mundlak) in Stan. I try to follow his code, do the same with brms, and try to implement a solution Matti Vuorre posted."/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","categories","output"]}},"value":[{"type":"character","attributes":{},"value":["Latent group means with brms"]},{"type":"character","attributes":{},"value":["Richard McElreath recently shared a tutorial on how to do estimate latent group means (à la Mundlak) in Stan. I try to follow his code, do the same with brms, and try to implement a solution Matti Vuorre posted.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Ruben C. Arslan"]},{"type":"character","attributes":{},"value":["https://rubenarslan.github.io"]}]}]},{"type":"character","attributes":{},"value":["2023-03-15"]},{"type":"character","attributes":{},"value":["brms","modelling","quick job"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","code_folding","toc","toc_float"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"logical","attributes":{},"value":[true]},{"type":"logical","attributes":{},"value":[true]}]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["latent-group-mean-centering-revisited_files/anchor-4.2.2/anchor.min.js","latent-group-mean-centering-revisited_files/bowser-1.9.3/bowser.min.js","latent-group-mean-centering-revisited_files/distill-2.2.21/template.v2.js","latent-group-mean-centering-revisited_files/figure-html5/biasb-1.png","latent-group-mean-centering-revisited_files/figure-html5/biasg-1.png","latent-group-mean-centering-revisited_files/figure-html5/biasgb-1.png","latent-group-mean-centering-revisited_files/figure-html5/unnamed-chunk-21-1.png","latent-group-mean-centering-revisited_files/figure-html5/unnamed-chunk-22-1.png","latent-group-mean-centering-revisited_files/header-attrs-2.17/header-attrs.js","latent-group-mean-centering-revisited_files/jquery-3.6.0/jquery-3.6.0.js","latent-group-mean-centering-revisited_files/jquery-3.6.0/jquery-3.6.0.min.js","latent-group-mean-centering-revisited_files/jquery-3.6.0/jquery-3.6.0.min.map","latent-group-mean-centering-revisited_files/popper-2.6.0/popper.min.js","latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy-bundle.umd.min.js","latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy-light-border.css","latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy.css","latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy.umd.min.js","latent-group-mean-centering-revisited_files/webcomponents-2.0.0/webcomponents.js","mundlak.jpg"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
    font-size: 100%;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        const citeChild = $(this).children()[0]
        // Do not process if @xyz has been used without escaping and without bibliography activated
        // https://github.com/rstudio/distill/issues/466
        if (citeChild === undefined) return true

        if (citeChild.nodeName == "D-FOOTNOTE") {
          var fn = citeChild
          $(this).html(fn.shadowRoot.querySelector("sup"))
          $(this).id = fn.id
          fn.remove()
        }
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          // Could use CSS.escape too here, we insure backward compatibility in navigator
          return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // fix footnotes in tables (#411)
      // replacing broken distill.pub feature
      $('table d-footnote').each(function() {
        // we replace internal showAtNode methode which is triggered when hovering a footnote
        this.hoverBox.showAtNode = function(node) {
          // ported from https://github.com/distillpub/template/pull/105/files
          calcOffset = function(elem) {
              let x = elem.offsetLeft;
              let y = elem.offsetTop;
              // Traverse upwards until an `absolute` element is found or `elem`
              // becomes null.
              while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                  x += elem.offsetLeft;
                  y += elem.offsetTop;
              }

              return { left: x, top: y };
          }
          // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
          const bbox = node.getBoundingClientRect();
          const offset = calcOffset(node);
          this.show([offset.left + bbox.width, offset.top + bbox.height]);
        }
      })

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      // ignore leaflet img layers (#106)
      figures = figures.filter(':not(img[class*="leaflet"])')
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="latent-group-mean-centering-revisited_files/header-attrs-2.17/header-attrs.js"></script>
  <script src="latent-group-mean-centering-revisited_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="latent-group-mean-centering-revisited_files/popper-2.6.0/popper.min.js"></script>
  <link href="latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="latent-group-mean-centering-revisited_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="latent-group-mean-centering-revisited_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="latent-group-mean-centering-revisited_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="latent-group-mean-centering-revisited_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="latent-group-mean-centering-revisited_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Latent group means with brms","description":"Richard McElreath recently shared a tutorial on how to do estimate latent group means (à la Mundlak) in Stan. I try to follow his code, do the same with brms, and try to implement a solution Matti Vuorre posted.","authors":[{"author":"Ruben C. Arslan","authorURL":"https://rubenarslan.github.io","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2023-03-15T00:00:00.000+01:00","citationText":"Arslan, 2023"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Latent group means with brms</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt-tag">brms</div>
<div class="dt-tag">modelling</div>
<div class="dt-tag">quick job</div>
</div>
<!--/radix_placeholder_categories-->
<p><p>Richard McElreath recently shared a tutorial on how to do estimate latent group means (à la Mundlak) in Stan. I try to follow his code, do the same with brms, and try to implement a solution Matti Vuorre posted.</p></p>
</div>

<div class="d-byline">
  Ruben C. Arslan <a href="https://rubenarslan.github.io" class="uri">https://rubenarslan.github.io</a> 
  
<br/>2023-03-15
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#how-did-it-go-high-level-summary" id="toc-how-did-it-go-high-level-summary">How did it go? <small style="font-size:0.7em;color:gray">High-level summary</small></a></li>
<li><a href="#bernoulli-simulations" id="toc-bernoulli-simulations">Bernoulli simulations</a>
<ul>
<li><a href="#naive" id="toc-naive">Naive</a></li>
<li><a href="#fixed-effects" id="toc-fixed-effects">Fixed effects</a></li>
<li><a href="#multilevel" id="toc-multilevel">Multilevel</a></li>
<li><a href="#multilevel-mundlak" id="toc-multilevel-mundlak">Multilevel Mundlak</a></li>
<li><a href="#multilevel-latent-mundlak" id="toc-multilevel-latent-mundlak">Multilevel Latent Mundlak</a></li>
<li><a href="#non-working-implementation-of-matti-vuorres-approach" id="toc-non-working-implementation-of-matti-vuorres-approach">non-working implementation of Matti Vuorre’s approach</a></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
</ul></li>
<li><a href="#gaussian-simulations" id="toc-gaussian-simulations">Gaussian simulations</a>
<ul>
<li><a href="#naive-1" id="toc-naive-1">Naive</a></li>
<li><a href="#fixed-effects-1" id="toc-fixed-effects-1">Fixed effects</a></li>
<li><a href="#multilevel-1" id="toc-multilevel-1">Multilevel</a></li>
<li><a href="#multilevel-mundlak-1" id="toc-multilevel-mundlak-1">Multilevel Mundlak</a></li>
<li><a href="#multilevel-latent-mundlak-1" id="toc-multilevel-latent-mundlak-1">Multilevel Latent Mundlak</a></li>
<li><a href="#summary-1" id="toc-summary-1">Summary</a></li>
</ul></li>
<li><a href="#gaussian-binary-exposure-simulations" id="toc-gaussian-binary-exposure-simulations">Gaussian + binary exposure simulations</a>
<ul>
<li><a href="#naive-2" id="toc-naive-2">Naive</a></li>
<li><a href="#fixed-effects-2" id="toc-fixed-effects-2">Fixed effects</a></li>
<li><a href="#multilevel-2" id="toc-multilevel-2">Multilevel</a></li>
<li><a href="#multilevel-mundlak-2" id="toc-multilevel-mundlak-2">Multilevel Mundlak</a></li>
<li><a href="#multilevel-latent-mundlak-2" id="toc-multilevel-latent-mundlak-2">Multilevel Latent Mundlak</a></li>
<li><a href="#summary-2" id="toc-summary-2">Summary</a></li>
</ul></li>
</ul>
</nav>
</div>
<p>In a recent <a href="https://youtu.be/iwVqiiXYeC4?t=3299">lecture</a>, <a href="https://twitter.com/rlmcelreath">Richard McElreath</a> gave an introduction to Mundlak devices (<a href="https://github.com/rmcelreath/stat_rethinking_2023/blob/main/scripts/12_bonus_mundlak.r">code</a>). Briefly, social scientists would often like to remove confounding at the group level.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<aside>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>knitr</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/knitr/man/include_graphics.html'>include_graphics</a></span><span class='op'>(</span><span class='st'>"mundlak.jpg"</span><span class='op'>)</span></span></code></pre>
</div>
</details>
<p><img src="mundlak.jpg" width="508" /></p>
</div>
<a href="https://en.wikipedia.org/wiki/Yair_Mundlak">Yair Mundlak</a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> in his Full Luxury Bayes outfit, courtesy of DALL-E.
</aside>
<p>Econometricians and epidemiologists tend to use fixed effects regression to do so. Psychologists often use random effects regressions and adjust for the mean of the predictor of interest. The two solutions yield similar results for the within-group effect, but differ on how they treat group-level effects.</p>
<p><a href="https://www.annualreviews.org/doi/full/10.1146/annurev-statistics-040120-024521#_i31">Arguably</a>, there are more ways to mess up the random effects model, but it’s more flexible and efficient and it makes it easier to model e.g., cross-level interactions and effect heterogeneity.</p>
<p>One way you can mess up, is if your group sizes are small (e.g., sibling groups in a low fertility country) and your estimate of the group mean is a poor stand-in for the confounds you’d like to adjust for. A solution to this is to estimate the latent group mean instead, i.e. to account for the fact that we are estimating it with uncertainty. Doing so<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> is fairly easy in Stan, but it’s less clear how to do it with everyone’s favourite Stan interface, brms.</p>
<p>In which way does this sampling error at the group level bias your results? It attenuates your estimate of <code>b_Xbar</code> (<a href="https://pubmed.ncbi.nlm.nih.gov/18778152/">Lüdtke’s bias</a>). I thought it would also bias my estimate of <code>b_X</code>, because I’m underadjusting by ignoring the measurement error in my covariate. That is not so. Why? To get the intuition, it helped me to consider the case where I first subtract <code>Xbar</code> from <code>X</code>. <code>Xdiff</code> is necessarily uncorrelated with <code>Xbar</code>, meaning any changes in the association of <code>Xbar</code> and <code>Y</code> (which we get by modelling sampling error) are irrelevant to <code>Y ~ Xdiff</code>.</p>
<p>I think I’m not the only who is confused about this. <a href="https://twitter.com/vuorre">Matti Vuorre</a> shared <a href="https://vuorre.netlify.app/posts/latent-mean-centering/#brms">a solution</a> to center X with the latent group mean using brms’ non-linear syntax. Centering with the latent group mean is not necessary though. Also, I tried the syntax and it doesn’t correctly recover simulated effects.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>My two attempts at a solution:</p>
<p>Using <code>me()</code></p>
<ol type="1">
<li>Calculate the group mean <code>Xbar</code>, e.g. <code>df %&gt;% group_by(id) %&gt;% mutate(Xbar = mean(X))</code>.</li>
<li>Calculate the standard error of the mean , e.g. <code>df %&gt;% group_by(id) %&gt;% mutate(Xse = sd(X)/sqrt(n()))</code>.</li>
<li>Adjust for the term <code>me(Xbar, Xse, gr = id)</code> explicitly specifying the grouping variable.</li>
<li>Profit</li>
</ol>
<p>Using <code>mi()</code></p>
<ol type="1">
<li>Duplicating the exposure <code>X-&gt;X2</code></li>
<li>Calculating the SE of the group mean outside the brms call</li>
<li>Using a second formula <code>bf(X2 | mi(Xse) ~ (1|id))</code> in brms to estimate the latent group mean with shrinkage.</li>
<li>Adjusting for <code>mi(X2)</code> in the regression on <code>Y</code>.</li>
</ol>
<h2 id="how-did-it-go-high-level-summary">How did it go? <small style="font-size:0.7em;color:gray">High-level summary</small></h2>
<ul>
<li>My solutions seem to work, but they’re a little hacky. The <code>me</code> approach didn’t work for me at first until I specified the grouping variable, which makes sense.</li>
<li>I had to add a constant <code>.01</code> to <code>Xse</code> when SE was zero (in my Bernoulli exposure simulation).</li>
<li><code>mi()</code> cannot be combined with non-Gaussian variables. If I treat binary exposure <code>X</code> as Gaussian in a LPM, convergence was difficult and I had to fix the sigma to 0.01. The <code>me()</code> approach seems to work though. If I do all this, the three approaches (rethinking, me, mi) converge.</li>
<li>I never managed to create a simulated scenaro where the latent Mundlak approach consistently outperforms the non-latent Mundlak for <code>b_X</code>. It improves estimates for <code>b_Xbar</code> (i.e. the group-level confound), so it’s doing what it’s supposed to, but <code>b_X</code> is always already estimated close to the true value with a non-latent Mundlak model. I tried to create conditions to make outperformance likely (small group sizes, much within-subject variation in X relative to between-subject variation, so that Xbar poorly correlates with the group-level confound). <strong>Am I missing something in my simulations or is latent group mean centering rarely worth the effort?</strong> I’d be glad for any pointers. <strong>Edit:</strong> <a href="https://twitter.com/niclas_kuper">Niclas Kuper</a> gave me the pointer I needed, so I have clarified above that we do not expect estimation of <code>b_X</code> to improve by using latent group means.</li>
</ul>
<p>The simulations and their results are documented in detail below. Click on the “Implementations” to see the model code.</p>
<h2 id="bernoulli-simulations">Bernoulli simulations</h2>
<p>I started with Richard’s simulations of a binary outcome. I was not able to reproduce his model performances exactly and ended up increasing the simulated sample size to make estimates a bit more stable (to more clearly show bias vs. variance).</p>
<p>Up to the latent Mundlak model, the brms equivalents, perform, well, equivalently. For the latent Mundlak model, the brms gets slightly different coefficients, but a similar overall result.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>rethinking</span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mjskay.github.io/tidybayes/'>tidybayes</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://mjskay.github.io/tidybayes.rethinking'>tidybayes.rethinking</a></span><span class='op'>)</span></span>
<span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/paul-buerkner/brms'>brms</a></span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/options.html'>options</a></span><span class='op'>(</span>brms.backend <span class='op'>=</span> <span class='st'>"cmdstanr"</span>,  <span class='co'># I use the cmdstanr backend</span></span>
<span>        mc.cores <span class='op'>=</span> <span class='fl'>8</span>, </span>
<span>        brms.threads <span class='op'>=</span> <span class='fl'>1</span>,           <span class='co'># which allows me to multithread</span></span>
<span>        brms.file_refit <span class='op'>=</span> <span class='st'>"on_change"</span><span class='op'>)</span> <span class='co'># this is useful when doing </span></span>
<span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>201910</span><span class='op'>)</span></span>
<span></span>
<span><span class='co'># families</span></span>
<span><span class='va'>N_groups</span> <span class='op'>&lt;-</span> <span class='fl'>300</span></span>
<span><span class='va'>a0</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='op'>-</span><span class='fl'>2</span><span class='op'>)</span></span>
<span><span class='va'>b_X</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span><span class='va'>b_Z</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='op'>-</span><span class='fl'>0.5</span><span class='op'>)</span></span>
<span><span class='va'>b_Ug</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>3</span><span class='op'>)</span></span>
<span><span class='co'># 2 or more siblings</span></span>
<span><span class='va'>g_sizes</span> <span class='op'>&lt;-</span> <span class='fl'>2</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span><span class='va'>N_groups</span>, lambda <span class='op'>=</span> <span class='fl'>0.2</span><span class='op'>)</span> <span class='co'># sample into groups</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>N_id</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>g</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span>, times <span class='op'>=</span> <span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>Ug</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_groups</span>, sd <span class='op'>=</span> <span class='fl'>0.8</span><span class='op'>)</span> <span class='co'># group confounds</span></span>
<span><span class='va'>X</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_id</span>, <span class='va'>Ug</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>)</span> <span class='co'># individual varying trait</span></span>
<span><span class='va'>Z</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_groups</span><span class='op'>)</span> <span class='co'># group varying trait (observed)</span></span>
<span><span class='va'>Y</span> <span class='op'>&lt;-</span> <span class='fu'>rbern</span><span class='op'>(</span><span class='va'>N_id</span>, p<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/rethinking-internal.html'>inv_logit</a></span><span class='op'>(</span> <span class='va'>a0</span> <span class='op'>+</span> <span class='va'>b_X</span> <span class='op'>*</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Ug</span><span class='op'>*</span><span class='va'>Ug</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>)</span> <span class='op'>)</span></span>
<span></span>
<span><span class='co'># glm(Y ~ X + Z[g] + Ug[g], binomial())</span></span>
<span><span class='co'># glm(Y ~ X + Z[g], binomial())</span></span>
<span><span class='va'>groups</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span><span class='op'>)</span>, <span class='va'>Ug</span>, <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='va'>sim</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span>, <span class='va'>X</span>, <span class='va'>Y</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>full_join</a></span><span class='op'>(</span><span class='va'>groups</span>, by <span class='op'>=</span> <span class='st'>"id"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>Xbar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span><span class='va'>sim</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>Ug</span>, <span class='va'>Xbar</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span>use <span class='op'>=</span> <span class='st'>"p"</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>, <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"logit"</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>Ug</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>, <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"logit"</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>id</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>, <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"logit"</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim</span> <span class='op'>&lt;-</span> <span class='va'>sim</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>Xse <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>X2 <span class='op'>=</span> <span class='va'>X</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<details>
<summary>
Implementations of the various models
</summary>
<h3 id="naive">Naive</h3>
<h4 id="rethinking">rethinking</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, X <span class='op'>=</span> <span class='va'>X</span>, g <span class='op'>=</span> <span class='va'>g</span>, Ng <span class='op'>=</span> <span class='va'>N_groups</span>, Z <span class='op'>=</span> <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='va'>mn</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/ulam.html'>ulam</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>        <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>,</span>
<span>        <span class='fu'>logit</span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>a</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>        <span class='va'>a</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>2</span><span class='op'>)</span>,</span>
<span>        <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>,<span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span></span>
<span>    <span class='op'>)</span> , data<span class='op'>=</span><span class='va'>dat</span> , chains<span class='op'>=</span><span class='fl'>4</span> , cores<span class='op'>=</span><span class='fl'>4</span> <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>mn</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mn</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mn</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 2)"</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mn</span></span>
<span></span>
<span><span class='va'>b_mn</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="fixed-effects">Fixed effects</h3>
<h4 id="rethinking-1">rethinking</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, X <span class='op'>=</span> <span class='va'>X</span>, g <span class='op'>=</span> <span class='va'>g</span>, Ng <span class='op'>=</span> <span class='va'>N_groups</span>, Z <span class='op'>=</span> <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='co'># fixed effects</span></span>
<span><span class='va'>mf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/ulam.html'>ulam</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>  <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>,</span>
<span>  <span class='fu'>logit</span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>  <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1.5</span><span class='op'>)</span>, <span class='co'># can't get it to work using dunif(-1,1)</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>,<span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span></span>
<span><span class='op'>)</span>, data<span class='op'>=</span><span class='va'>dat</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, cores<span class='op'>=</span><span class='fl'>4</span> <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>mf</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms-1">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='va'>id</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span></span>
<span>              ,<span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"uniform(-1, 1)"</span>,lb <span class='op'>=</span> <span class='op'>-</span><span class='fl'>1</span>, ub <span class='op'>=</span> <span class='fl'>1</span>, class <span class='op'>=</span> <span class='st'>"b"</span><span class='op'>)</span><span class='op'>)</span></span>
<span>            <span class='co'># , sample_prior = "only"</span></span>
<span>            <span class='op'>)</span></span>
<span></span>
<span><span class='co'># b_mf %&gt;% gather_draws(`b_id.*`, regex=T) %&gt;% </span></span>
<span><span class='co'>#   ggplot(aes(inv_logit(.value))) + geom_histogram(binwidth = .01)</span></span>
<span><span class='va'>b_mf</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel">Multilevel</h3>
<h4 id="rethinking-2">Rethinking</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># varying effects (non-centered - next week! )</span></span>
<span><span class='va'>mr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/ulam.html'>ulam</a></span><span class='op'>(</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>    <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>,</span>
<span>    <span class='fu'>logit</span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>transpars</span> <span class='op'>&gt;</span> <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>a</span> <span class='op'>&lt;&lt;-</span> <span class='va'>abar</span> <span class='op'>+</span> <span class='va'>z</span><span class='op'>*</span><span class='va'>tau</span>,</span>
<span>    <span class='va'>z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>,<span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>abar</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>tau</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span>, data<span class='op'>=</span><span class='va'>dat</span> , chains<span class='op'>=</span><span class='fl'>4</span>, cores<span class='op'>=</span><span class='fl'>4</span>, sample<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mr</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms-2">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mr</span></span>
<span></span>
<span><span class='va'>b_mr</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-mundlak">Multilevel Mundlak</h3>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># The Mundlak Machine</span></span>
<span><span class='va'>xbar</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>j</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span> <span class='op'>(</span><span class='va'>X</span><span class='op'>[</span><span class='va'>g</span><span class='op'>==</span><span class='va'>j</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>dat</span><span class='op'>$</span><span class='va'>Xbar</span> <span class='op'>&lt;-</span> <span class='va'>xbar</span></span>
<span><span class='va'>mrx</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/ulam.html'>ulam</a></span><span class='op'>(</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>    <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>,</span>
<span>    <span class='fu'>logit</span> <span class='op'>(</span><span class='va'>p</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>buy</span><span class='op'>*</span><span class='va'>Xbar</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>transpars</span><span class='op'>&gt;</span> <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>a</span> <span class='op'>&lt;&lt;-</span> <span class='va'>abar</span> <span class='op'>+</span> <span class='va'>z</span><span class='op'>*</span><span class='va'>tau</span>, </span>
<span>    <span class='va'>z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>buy</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>abar</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>tau</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span>,</span>
<span>data<span class='op'>=</span><span class='va'>dat</span>, chains<span class='op'>=</span><span class='fl'>4</span>, cores<span class='op'>=</span><span class='fl'>4</span> ,</span>
<span>sample<span class='op'>=</span><span class='cn'>TRUE</span> <span class='op'>)</span></span>
<span></span>
<span><span class='va'>mrx</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms-3">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mrx</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='va'>Xbar</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Xbar"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mrx</span></span>
<span></span>
<span><span class='va'>b_mrx</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="subtracting-the-group-mean-instead-of-adjusting-for-it">subtracting the group mean instead of adjusting for it</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mrc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brm.html'>brm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>X <span class='op'>=</span> <span class='va'>X</span> <span class='op'>-</span> <span class='va'>Xbar</span><span class='op'>)</span>,</span>
<span>            family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'><a href='https://rdrr.io/pkg/brms/man/set_prior.html'>set_prior</a></span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mrc</span></span>
<span></span>
<span><span class='va'>b_mrc</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-latent-mundlak">Multilevel Latent Mundlak</h3>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># The Latent Mundlak Machine</span></span>
<span><span class='va'>mru</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/ulam.html'>ulam</a></span><span class='op'>(</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>    <span class='co'># y model </span></span>
<span>    <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/pkg/brms/man/brmsfamily.html'>bernoulli</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>,</span>
<span>    <span class='fu'>logit</span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>buy</span><span class='op'>*</span><span class='va'>u</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>transpars</span><span class='op'>&gt;</span> <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>a</span> <span class='op'>&lt;&lt;-</span> <span class='va'>abar</span> <span class='op'>+</span> <span class='va'>z</span><span class='op'>*</span><span class='va'>tau</span>,</span>
<span>    <span class='co'># X model</span></span>
<span>    <span class='va'>X</span> <span class='op'>~</span> <span class='fu'>normal</span><span class='op'>(</span><span class='va'>mu</span>,<span class='va'>sigma</span><span class='op'>)</span>,</span>
<span>    <span class='va'>mu</span> <span class='op'>&lt;-</span> <span class='va'>aX</span> <span class='op'>+</span> <span class='va'>bux</span><span class='op'>*</span><span class='va'>u</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>u</span> <span class='op'>~</span> <span class='fu'>normal</span> <span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    </span>
<span>    <span class='co'># priors</span></span>
<span>    <span class='va'>z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>aX</span>, <span class='va'>b_X</span>, <span class='va'>buy</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>bux</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>abar</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span> <span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>tau</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>sigma</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span>,</span>
<span>  data <span class='op'>=</span> <span class='va'>dat</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, cores<span class='op'>=</span><span class='fl'>4</span>, sample<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mru</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/point_interval.html'>mean_hdci</a></span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms-4">brms</h4>
<h5 id="brms-me-measurement-error-notation">brms me() measurement error notation</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_gr</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='fu'>me</span><span class='op'>(</span><span class='va'>Xbar</span>, <span class='va'>Xse</span>, gr <span class='op'>=</span> <span class='va'>id</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>sim</span>, </span>
<span>                family <span class='op'>=</span> <span class='fu'>bernoulli</span><span class='op'>(</span><span class='op'>)</span>,</span>
<span>             prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"meXbarXsegrEQid"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sdme"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="brms-mi-missingness-notation">brms mi() missingness notation</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_mi</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='fu'>bf</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>X2</span><span class='op'>)</span>, family <span class='op'>=</span> <span class='fu'>bernoulli</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>             <span class='fu'>bf</span><span class='op'>(</span><span class='va'>X2</span> <span class='op'>|</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>Xse</span><span class='op'>)</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span>, </span>
<span>                family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"miX2"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sigma"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mru_mi</span></span>
<span></span>
<span><span class='va'>b_mru_mi</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_Y_X</span>, <span class='va'>b_Y_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="non-working-implementation-of-matti-vuorres-approach">non-working implementation of Matti Vuorre’s approach</h3>
<p>This is the approach Matti Vuorre posted on his blog, except that I rearranged to instead the slope of Xbar. This approach does not work at all, as far as I can tell.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>latent_formula</span> <span class='op'>&lt;-</span> <span class='fu'>bf</span><span class='op'>(</span></span>
<span>  <span class='co'># Y model</span></span>
<span>  <span class='va'>Y</span> <span class='op'>~</span> <span class='va'>interceptY</span>  <span class='op'>+</span> <span class='va'>bX</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>bXbar</span><span class='op'>*</span><span class='va'>Xbar</span> <span class='op'>+</span> <span class='va'>bZ</span><span class='op'>*</span><span class='va'>Z</span>,</span>
<span>  <span class='va'>interceptY</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>id</span><span class='op'>)</span>,</span>
<span>  <span class='va'>bX</span> <span class='op'>+</span> <span class='va'>bZ</span> <span class='op'>+</span> <span class='va'>bXbar</span> <span class='op'>~</span> <span class='fl'>1</span>,</span>
<span></span>
<span>  <span class='co'># Xbar model</span></span>
<span>  <span class='fu'>nlf</span><span class='op'>(</span><span class='va'>X</span> <span class='op'>~</span> <span class='va'>Xbar</span><span class='op'>)</span>,</span>
<span>  <span class='va'>Xbar</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>id</span><span class='op'>)</span>,</span>
<span>  nl <span class='op'>=</span> <span class='cn'>TRUE</span></span>
<span><span class='op'>)</span> <span class='co'>#+</span></span>
<span><span class='co'>#  bernoulli()</span></span>
<span></span>
<span><span class='fu'>get_prior</span><span class='op'>(</span><span class='va'>latent_formula</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span></code></pre>
</div>
</details>
<pre><code>                prior class      coef group resp dpar      nlpar lb
 student_t(3, 0, 2.5) sigma                                       0
               (flat)     b                                   bX   
               (flat)     b Intercept                         bX   
               (flat)     b                                bXbar   
               (flat)     b Intercept                      bXbar   
               (flat)     b                                   bZ   
               (flat)     b Intercept                         bZ   
               (flat)     b                           interceptY   
               (flat)     b Intercept                 interceptY   
 student_t(3, 0, 2.5)    sd                           interceptY  0
 student_t(3, 0, 2.5)    sd              id           interceptY  0
 student_t(3, 0, 2.5)    sd Intercept    id           interceptY  0
               (flat)     b                                 Xbar   
               (flat)     b Intercept                       Xbar   
 student_t(3, 0, 2.5)    sd                                 Xbar  0
 student_t(3, 0, 2.5)    sd              id                 Xbar  0
 student_t(3, 0, 2.5)    sd Intercept    id                 Xbar  0
 ub       source
         default
         default
    (vectorized)
         default
    (vectorized)
         default
    (vectorized)
         default
    (vectorized)
         default
    (vectorized)
    (vectorized)
         default
    (vectorized)
         default
    (vectorized)
    (vectorized)</code></pre>
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_mv</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>latent_formula</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"bX"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"bZ"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"bXbar"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"Xbar"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"interceptY"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, nlpar <span class='op'>=</span> <span class='st'>"interceptY"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, nlpar <span class='op'>=</span> <span class='st'>"Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
<pre><code>
SAMPLING FOR MODEL &#39;3f860d32989dccf8dfe1419c5089d23e&#39; NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 0.000188 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.88 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 57.3365 seconds (Warm-up)
Chain 1:                43.5455 seconds (Sampling)
Chain 1:                100.882 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL &#39;3f860d32989dccf8dfe1419c5089d23e&#39; NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 0.000173 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.73 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 52.9574 seconds (Warm-up)
Chain 2:                73.3569 seconds (Sampling)
Chain 2:                126.314 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL &#39;3f860d32989dccf8dfe1419c5089d23e&#39; NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 0.000139 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.39 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 69.7308 seconds (Warm-up)
Chain 3:                62.2176 seconds (Sampling)
Chain 3:                131.948 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL &#39;3f860d32989dccf8dfe1419c5089d23e&#39; NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 0.000137 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.37 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 63.9066 seconds (Warm-up)
Chain 4:                69.5717 seconds (Sampling)
Chain 4:                133.478 seconds (Total)
Chain 4: </code></pre>
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_mv</span></span></code></pre>
</div>
</details>
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: Y ~ interceptY + bX * X + bXbar * Xbar + bZ * Z 
         interceptY ~ 1 + (1 | id)
         bX ~ 1
         bZ ~ 1
         bXbar ~ 1
         X ~ Xbar
         Xbar ~ 1 + (1 | id)
   Data: sim (Number of observations: 646) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Group-Level Effects: 
~id (Number of levels: 300) 
                         Estimate Est.Error l-95% CI u-95% CI Rhat
sd(interceptY_Intercept)     0.20      0.11     0.01     0.36 1.12
sd(Xbar_Intercept)           0.55      0.44     0.05     1.75 1.02
                         Bulk_ESS Tail_ESS
sd(interceptY_Intercept)       30      194
sd(Xbar_Intercept)            242      255

Population-Level Effects: 
                     Estimate Est.Error l-95% CI u-95% CI Rhat
interceptY_Intercept     0.22      0.51    -0.95     1.24 1.01
bX_Intercept             0.08      0.83    -1.55     1.73 1.04
bZ_Intercept            -0.03      0.02    -0.07     0.02 1.00
bXbar_Intercept          0.11      0.83    -1.52     1.74 1.05
Xbar_Intercept           0.02      0.75    -1.45     1.53 1.01
                     Bulk_ESS Tail_ESS
interceptY_Intercept     1921     1750
bX_Intercept               79     1543
bZ_Intercept             2207     2403
bXbar_Intercept            52     1353
Xbar_Intercept           1418     1121

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.31      0.01     0.29     0.34 1.00     1625     1830

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</details>
<h3 id="summary">Summary</h3>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span></span>
<span>  rethinking_naive <span class='op'>=</span> <span class='va'>mn</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  rethinking_fixed <span class='op'>=</span> <span class='va'>mf</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  rethinking_multilevel <span class='op'>=</span> <span class='va'>mr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  rethinking_mundlak <span class='op'>=</span> <span class='va'>mrx</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>buy</span><span class='op'>)</span>,</span>
<span>  brms_naive <span class='op'>=</span> <span class='va'>b_mn</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_fixed <span class='op'>=</span> <span class='va'>b_mf</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_multilevel <span class='op'>=</span> <span class='va'>b_mr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_mundlak <span class='op'>=</span> <span class='va'>b_mrx</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>b_Xbar</span><span class='op'>)</span>,</span>
<span>  brms_mundlak_centered <span class='op'>=</span> <span class='va'>b_mrc</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  rethinking_latent_mundlak <span class='op'>=</span> <span class='va'>mru</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>buy</span><span class='op'>)</span>,</span>
<span>  brms_latent_mundlak <span class='op'>=</span> <span class='va'>b_mru_gr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>bsp_meXbarXsegrEQid</span><span class='op'>)</span>,</span>
<span>  brms_latent_mundlak_mi <span class='op'>=</span> <span class='va'>b_mru_mi</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_Y_X</span>, <span class='va'>b_Y_Z</span>, <span class='va'>bsp_Y_miX2</span><span class='op'>)</span>,</span>
<span> .id <span class='op'>=</span> <span class='st'>"model"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>separate</span><span class='op'>(</span><span class='va'>model</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"package"</span>, <span class='st'>"model"</span><span class='op'>)</span>, extra <span class='op'>=</span> <span class='st'>"merge"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mutate</span><span class='op'>(</span>model <span class='op'>=</span> <span class='fu'>fct_inorder</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>model</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'>str_replace</span><span class='op'>(</span><span class='va'>.variable</span>, <span class='st'>"_Y"</span>, <span class='st'>""</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'>recode</span><span class='op'>(</span><span class='va'>.variable</span>, </span>
<span>                            <span class='st'>"buy"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span>,</span>
<span>                            <span class='st'>"bsp_miX2"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span>,</span>
<span>                            <span class='st'>"bsp_meXbarXsegrEQid"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>.variable</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='va'>draws</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>package</span>, <span class='va'>model</span>, <span class='va'>.variable</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mean_hdci</span><span class='op'>(</span>.width <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.95</span>, <span class='fl'>.99</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>draws</span>, <span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>package</span>, x <span class='op'>=</span> <span class='va'>.value</span>, xmin <span class='op'>=</span> <span class='va'>.lower</span>, xmax <span class='op'>=</span> <span class='va'>.upper</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_pointinterval</span><span class='op'>(</span>position <span class='op'>=</span> <span class='fu'>position_dodge</span><span class='op'>(</span>width <span class='op'>=</span> <span class='fl'>.4</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>ggrepel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html'>geom_text_repel</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>label <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>.width</span> <span class='op'>==</span> <span class='fl'>.95</span>, <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"%.2f"</span>, <span class='va'>.value</span><span class='op'>)</span>, <span class='cn'>NA_character_</span><span class='op'>)</span><span class='op'>)</span>, nudge_y <span class='op'>=</span> <span class='fl'>.1</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_vline</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>true_val</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='st'>'dashed'</span>, data <span class='op'>=</span> <span class='fu'>tibble</span><span class='op'>(</span>true_val <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>b_Ug</span> <span class='op'>-</span> <span class='va'>b_X</span><span class='op'>)</span>, .variable <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>  <span class='fu'>scale_color_discrete</span><span class='op'>(</span>breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>draws</span><span class='op'>$</span><span class='va'>model</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>facet_grid</span><span class='op'>(</span><span class='va'>model</span> <span class='op'>~</span> <span class='va'>.variable</span>, scales <span class='op'>=</span> <span class='st'>"free_x"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.99</span>,<span class='fl'>0.99</span><span class='op'>)</span>,</span>
<span>        legend.justification <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
<div class="figure"><span style="display:block;" id="fig:biasb"></span>
<img src="latent-group-mean-centering-revisited_files/figure-html5/biasb-1.png" alt="Estimated coefficients and the true values (dashed line)" width="624" />
<p class="caption">
Figure 1: Estimated coefficients and the true values (dashed line)
</p>
</div>
</div>
<p>For some reason, I did not manage to specify a uniform prior in rethinking. I think this explains the poor showing for the rethinking fixed effects model. Fixed effects regression + Bayes is not really a happy couple.</p>
<h2 id="gaussian-simulations">Gaussian simulations</h2>
<p>Then, I simulated a Gaussian outcome instead. I didn’t run the rethinking models here, except for the latent Mundlak model.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>201910</span><span class='op'>)</span></span>
<span><span class='co'># families</span></span>
<span><span class='va'>N_groups</span> <span class='op'>&lt;-</span> <span class='fl'>300</span></span>
<span><span class='va'>a0</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='op'>-</span><span class='fl'>2</span><span class='op'>)</span></span>
<span><span class='va'>b_X</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span><span class='va'>b_Z</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='op'>-</span><span class='fl'>0.5</span><span class='op'>)</span></span>
<span><span class='va'>b_Ug</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>3</span><span class='op'>)</span></span>
<span><span class='co'># 2 or more siblings</span></span>
<span><span class='va'>g_sizes</span> <span class='op'>&lt;-</span> <span class='fl'>2</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span><span class='va'>N_groups</span>, lambda <span class='op'>=</span> <span class='fl'>0.2</span><span class='op'>)</span> <span class='co'># sample into groups</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>N_id</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>g</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span>, times <span class='op'>=</span> <span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>Ug</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_groups</span>, sd <span class='op'>=</span> <span class='fl'>0.8</span><span class='op'>)</span> <span class='co'># group confounds</span></span>
<span><span class='va'>X</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_id</span>, <span class='va'>Ug</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>)</span> <span class='co'># individual varying trait</span></span>
<span><span class='va'>Z</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_groups</span><span class='op'>)</span> <span class='co'># group varying trait (observed)</span></span>
<span><span class='va'>Y</span> <span class='op'>&lt;-</span> <span class='va'>a0</span> <span class='op'>+</span> <span class='va'>b_X</span> <span class='op'>*</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Ug</span><span class='op'>*</span><span class='va'>Ug</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_id</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>groups</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span><span class='op'>)</span>, <span class='va'>Ug</span>, <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='va'>sim</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span>, <span class='va'>X</span>, <span class='va'>Y</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>full_join</span><span class='op'>(</span><span class='va'>groups</span>, by <span class='op'>=</span> <span class='st'>"id"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>arrange</span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mutate</span><span class='op'>(</span>Xbar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span></span>
<span><span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>distinct</span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>Ug</span>, <span class='va'>Xbar</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>select</span><span class='op'>(</span><span class='op'>-</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span>use <span class='op'>=</span> <span class='st'>"p"</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>Ug</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>id</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim</span> <span class='op'>&lt;-</span> <span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mutate</span><span class='op'>(</span>Xse <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'>n</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mutate</span><span class='op'>(</span>X2 <span class='op'>=</span> <span class='va'>X</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<details>
<summary>
Implementations of the various models
</summary>
<h3 id="naive-1">Naive</h3>
<h4 id="brms-5">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mn</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 2)"</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mn</span></span>
<span></span>
<span><span class='va'>b_mn</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="fixed-effects-1">Fixed effects</h3>
<h4 id="brms-6">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mf</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='va'>id</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 2)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span><span class='op'>)</span><span class='op'>)</span></span>
<span>            <span class='co'># , sample_prior = "only"</span></span>
<span>            <span class='op'>)</span></span>
<span></span>
<span><span class='co'># b_mf %&gt;% gather_draws(`b_id.*`, regex=T) %&gt;% </span></span>
<span><span class='co'>#   ggplot(aes(inv_logit(.value))) + geom_histogram(binwidth = .01)</span></span>
<span><span class='va'>b_mf</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-1">Multilevel</h3>
<h4 id="brms-7">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mr</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mr</span></span>
<span></span>
<span><span class='va'>b_mr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-mundlak-1">Multilevel Mundlak</h3>
<h4 id="brms-8">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mrx</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='va'>Xbar</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Xbar"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mrx</span></span>
<span></span>
<span><span class='va'>b_mrx</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="subtracting-the-group-mean-instead-of-adjusting-for-it-1">subtracting the group mean instead of adjusting for it</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mrc</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>X <span class='op'>=</span> <span class='va'>X</span> <span class='op'>-</span> <span class='va'>Xbar</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mrc</span></span>
<span></span>
<span><span class='va'>b_mrc</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-latent-mundlak-1">Multilevel Latent Mundlak</h3>
<h4 id="rethinking-3">rethinking</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, X <span class='op'>=</span> <span class='va'>X</span>, g <span class='op'>=</span> <span class='va'>g</span>, Ng <span class='op'>=</span> <span class='va'>N_groups</span>, Z <span class='op'>=</span> <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='co'># The Latent Mundlak Machine</span></span>
<span><span class='va'>mru</span> <span class='op'>&lt;-</span> <span class='fu'>ulam</span><span class='op'>(</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>    <span class='co'># y model </span></span>
<span>    <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'>normal</span><span class='op'>(</span><span class='va'>muY</span>, <span class='va'>sigmaY</span><span class='op'>)</span>,</span>
<span>    <span class='va'>muY</span> <span class='op'>&lt;-</span> <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>buy</span><span class='op'>*</span><span class='va'>u</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>transpars</span><span class='op'>&gt;</span> <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>a</span> <span class='op'>&lt;&lt;-</span> <span class='va'>abar</span> <span class='op'>+</span> <span class='va'>z</span><span class='op'>*</span><span class='va'>tau</span>,</span>
<span>    <span class='co'># X model</span></span>
<span>    <span class='va'>X</span> <span class='op'>~</span> <span class='fu'>normal</span><span class='op'>(</span><span class='va'>mu</span>,<span class='va'>sigma</span><span class='op'>)</span>,</span>
<span>    <span class='va'>mu</span> <span class='op'>&lt;-</span> <span class='va'>aX</span> <span class='op'>+</span> <span class='va'>bux</span><span class='op'>*</span><span class='va'>u</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>u</span> <span class='op'>~</span> <span class='fu'>normal</span> <span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    </span>
<span>    <span class='co'># priors</span></span>
<span>    <span class='va'>z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>aX</span>, <span class='va'>b_X</span>, <span class='va'>buy</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>bux</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>abar</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span> <span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>tau</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>sigma</span>, <span class='va'>sigmaY</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span>,iter <span class='op'>=</span> <span class='fl'>2000</span>,</span>
<span>  data <span class='op'>=</span> <span class='va'>dat</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, cores<span class='op'>=</span><span class='fl'>4</span>, sample<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mru</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms-9">brms</h4>
<h5 id="brms-me-measurement-error-notation-1">brms me() measurement error notation</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_gr</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='fu'>me</span><span class='op'>(</span><span class='va'>Xbar</span>, <span class='va'>Xse</span>, gr <span class='op'>=</span> <span class='va'>id</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>sim</span>, </span>
<span>             prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"meXbarXsegrEQid"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sdme"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="brms-mi-missingness-notation-1">brms mi() missingness notation</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_mi</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='fu'>bf</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>X2</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>             <span class='fu'>bf</span><span class='op'>(</span><span class='va'>X2</span> <span class='op'>|</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>Xse</span><span class='op'>)</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span>, family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>X2 <span class='op'>=</span> <span class='va'>X</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"miX2"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sigma"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mru_mi</span></span>
<span></span>
<span><span class='va'>b_mru_mi</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_Y_X</span>, <span class='va'>b_Y_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="working-implementation-of-the-mi-model-using-nonlinear-syntax">working implementation of the mi model using nonlinear syntax</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>latent_formula</span> <span class='op'>&lt;-</span> <span class='fu'>bf</span><span class='op'>(</span>nl <span class='op'>=</span> <span class='cn'>TRUE</span>,</span>
<span>  <span class='co'># Y model</span></span>
<span>  <span class='va'>Y</span> <span class='op'>~</span> <span class='va'>interceptY</span>  <span class='op'>+</span> <span class='va'>bX</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>X2l</span> <span class='op'>+</span> <span class='va'>bZ</span><span class='op'>*</span><span class='va'>Z</span>,</span>
<span>  <span class='va'>X2l</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>X2</span><span class='op'>)</span>,</span>
<span>  <span class='va'>interceptY</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>id</span><span class='op'>)</span>,</span>
<span>  <span class='va'>bX</span> <span class='op'>+</span> <span class='va'>bZ</span> <span class='op'>~</span> <span class='fl'>1</span>, family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>bf</span><span class='op'>(</span><span class='va'>X2</span> <span class='op'>|</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>Xse</span><span class='op'>)</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span>, family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='co'>#+</span></span>
<span><span class='co'>#  bernoulli()</span></span>
<span></span>
<span><span class='co'># get_prior(latent_formula, data = sim)</span></span>
<span></span>
<span><span class='va'>b_mru_minl</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>latent_formula</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"X2l"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"bX"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"bZ"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='co'># set_prior("normal(0, 1)", class = "b", nlpar = "bX2", resp = "Y"),</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, nlpar <span class='op'>=</span> <span class='st'>"interceptY"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, nlpar <span class='op'>=</span> <span class='st'>"interceptY"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mru_minl</span></span></code></pre>
</div>
</details>
</div>
</details>
<h3 id="summary-1">Summary</h3>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span></span>
<span>  brms_naive <span class='op'>=</span> <span class='va'>b_mn</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_fixed <span class='op'>=</span> <span class='va'>b_mf</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_multilevel <span class='op'>=</span> <span class='va'>b_mr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_mundlak <span class='op'>=</span> <span class='va'>b_mrx</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>b_Xbar</span><span class='op'>)</span>,</span>
<span>  brms_mundlak_centered <span class='op'>=</span> <span class='va'>b_mrc</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  rethinking_latent_mundlak <span class='op'>=</span> <span class='va'>mru</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>buy</span><span class='op'>)</span>,</span>
<span>  brms_latent_mundlak <span class='op'>=</span> <span class='va'>b_mru_gr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>bsp_meXbarXsegrEQid</span><span class='op'>)</span>,</span>
<span>  brms_latent_mundlak_mi <span class='op'>=</span> <span class='va'>b_mru_mi</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_Y_X</span>, <span class='va'>b_Y_Z</span>, <span class='va'>bsp_Y_miX2</span><span class='op'>)</span>,</span>
<span> .id <span class='op'>=</span> <span class='st'>"model"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>separate</span><span class='op'>(</span><span class='va'>model</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"package"</span>, <span class='st'>"model"</span><span class='op'>)</span>, extra <span class='op'>=</span> <span class='st'>"merge"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mutate</span><span class='op'>(</span>model <span class='op'>=</span> <span class='fu'>fct_inorder</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>model</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'>str_replace</span><span class='op'>(</span><span class='va'>.variable</span>, <span class='st'>"_Y"</span>, <span class='st'>""</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'>recode</span><span class='op'>(</span><span class='va'>.variable</span>, </span>
<span>                            <span class='st'>"buy"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span>,</span>
<span>                            <span class='st'>"bsp_miX2"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span>,</span>
<span>                            <span class='st'>"bsp_meXbarXsegrEQid"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>.variable</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='va'>draws</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>package</span>, <span class='va'>model</span>, <span class='va'>.variable</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mean_hdci</span><span class='op'>(</span>.width <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.95</span>, <span class='fl'>.99</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>draws</span>, <span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>package</span>, x <span class='op'>=</span> <span class='va'>.value</span>, xmin <span class='op'>=</span> <span class='va'>.lower</span>, xmax <span class='op'>=</span> <span class='va'>.upper</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_pointinterval</span><span class='op'>(</span>position <span class='op'>=</span> <span class='fu'>position_dodge</span><span class='op'>(</span>width <span class='op'>=</span> <span class='fl'>.4</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>ggrepel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html'>geom_text_repel</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>label <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>.width</span> <span class='op'>==</span> <span class='fl'>.95</span>, <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"%.2f"</span>, <span class='va'>.value</span><span class='op'>)</span>, <span class='cn'>NA_character_</span><span class='op'>)</span><span class='op'>)</span>, nudge_y <span class='op'>=</span> <span class='fl'>.1</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_vline</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>true_val</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='st'>'dashed'</span>, data <span class='op'>=</span> <span class='fu'>tibble</span><span class='op'>(</span>true_val <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>b_Ug</span> <span class='op'>-</span> <span class='va'>b_X</span><span class='op'>)</span>, .variable <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>  <span class='fu'>scale_color_discrete</span><span class='op'>(</span>breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>draws</span><span class='op'>$</span><span class='va'>model</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>facet_grid</span><span class='op'>(</span><span class='va'>model</span> <span class='op'>~</span> <span class='va'>.variable</span>, scales <span class='op'>=</span> <span class='st'>"free_x"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.99</span>,<span class='fl'>0.99</span><span class='op'>)</span>,</span>
<span>        legend.justification <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
<div class="figure"><span style="display:block;" id="fig:biasg"></span>
<img src="latent-group-mean-centering-revisited_files/figure-html5/biasg-1.png" alt="Estimated coefficients and the true values (dashed line)" width="624" />
<p class="caption">
Figure 2: Estimated coefficients and the true values (dashed line)
</p>
</div>
</div>
<h2 id="gaussian-binary-exposure-simulations">Gaussian + binary exposure simulations</h2>
<p>Finally, I simulated a Gaussian outcome and a binary exposure (X). Especially in small groups, the group average of a binary variable can be pretty far off. I didn’t run the rethinking models here, except for the latent Mundlak model.</p>
<p>I was not able to implement this model in brms. brms does not permit the specification of a binary variable as missing using <code>mi()</code>. And adjusting for <code>Xbar</code> using a linear probability model did not work.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>201910</span><span class='op'>)</span></span>
<span><span class='co'># families</span></span>
<span><span class='va'>N_groups</span> <span class='op'>&lt;-</span> <span class='fl'>300</span></span>
<span><span class='va'>a0</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='op'>-</span><span class='fl'>2</span><span class='op'>)</span></span>
<span><span class='va'>b_X</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span><span class='va'>b_Z</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='op'>-</span><span class='fl'>0.5</span><span class='op'>)</span></span>
<span><span class='va'>b_Ug</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>3</span><span class='op'>)</span></span>
<span><span class='co'># 2 or more siblings</span></span>
<span><span class='va'>g_sizes</span> <span class='op'>&lt;-</span> <span class='fl'>2</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>rpois</a></span><span class='op'>(</span><span class='va'>N_groups</span>, lambda <span class='op'>=</span> <span class='fl'>0.2</span><span class='op'>)</span> <span class='co'># sample into groups</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>N_id</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>g</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span>, times <span class='op'>=</span> <span class='va'>g_sizes</span><span class='op'>)</span></span>
<span><span class='va'>Ug</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_groups</span>, sd <span class='op'>=</span> <span class='fl'>0.8</span><span class='op'>)</span> <span class='co'># group confounds</span></span>
<span><span class='va'>X</span> <span class='op'>&lt;-</span> <span class='fu'>rbern</span><span class='op'>(</span><span class='va'>N_id</span>, p<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/pkg/rethinking/man/rethinking-internal.html'>inv_logit</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_id</span>, <span class='va'>Ug</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>)</span> <span class='op'>)</span> <span class='op'>)</span>   <span class='co'># individual varying trait</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>Z</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_groups</span><span class='op'>)</span> <span class='co'># group varying trait (observed)</span></span>
<span><span class='va'>Y</span> <span class='op'>&lt;-</span> <span class='va'>a0</span> <span class='op'>+</span> <span class='va'>b_X</span> <span class='op'>*</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Ug</span><span class='op'>*</span><span class='va'>Ug</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N_id</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>groups</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>N_groups</span><span class='op'>)</span>, <span class='va'>Ug</span>, <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='va'>sim</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>g</span><span class='op'>)</span>, <span class='va'>X</span>, <span class='va'>Y</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>full_join</a></span><span class='op'>(</span><span class='va'>groups</span>, by <span class='op'>=</span> <span class='st'>"id"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>Xbar <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span><span class='va'>sim</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>Ug</span>, <span class='va'>Xbar</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span>use <span class='op'>=</span> <span class='st'>"p"</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>Ug</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>id</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>sim</span> <span class='op'>&lt;-</span> <span class='va'>sim</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>id</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>Xse <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>X2 <span class='op'>=</span> <span class='va'>X</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<details>
<summary>
Implementations of the various models
</summary>
<h3 id="naive-2">Naive</h3>
<h4 id="brms-10">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mn</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 2)"</span>, class <span class='op'>=</span> <span class='st'>"Intercept"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mn</span></span>
<span></span>
<span><span class='va'>b_mn</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="fixed-effects-2">Fixed effects</h3>
<h4 id="brms-11">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mf</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='va'>id</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 2)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span><span class='op'>)</span><span class='op'>)</span></span>
<span>            <span class='co'># , sample_prior = "only"</span></span>
<span>            <span class='op'>)</span></span>
<span></span>
<span><span class='co'># b_mf %&gt;% gather_draws(`b_id.*`, regex=T) %&gt;% </span></span>
<span><span class='co'>#   ggplot(aes(inv_logit(.value))) + geom_histogram(binwidth = .01)</span></span>
<span><span class='va'>b_mf</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-2">Multilevel</h3>
<h4 id="brms-12">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mr</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mr</span></span>
<span></span>
<span><span class='va'>b_mr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-mundlak-2">Multilevel Mundlak</h3>
<h4 id="brms-13">brms</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mrx</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='va'>Xbar</span>, data <span class='op'>=</span> <span class='va'>sim</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Xbar"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mrx</span></span>
<span></span>
<span><span class='va'>b_mrx</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="subtracting-the-group-mean-instead-of-adjusting-for-it-2">subtracting the group mean instead of adjusting for it</h5>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mrc</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span>, data <span class='op'>=</span> <span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>X <span class='op'>=</span> <span class='va'>X</span> <span class='op'>-</span> <span class='va'>Xbar</span><span class='op'>)</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mrc</span></span>
<span></span>
<span><span class='va'>b_mrc</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h3 id="multilevel-latent-mundlak-2">Multilevel Latent Mundlak</h3>
<h4 id="rethinking-4">rethinking</h4>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>dat</span> <span class='op'>&lt;-</span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>Y <span class='op'>=</span> <span class='va'>Y</span>, X <span class='op'>=</span> <span class='va'>X</span>, g <span class='op'>=</span> <span class='va'>g</span>, Ng <span class='op'>=</span> <span class='va'>N_groups</span>, Z <span class='op'>=</span> <span class='va'>Z</span><span class='op'>)</span></span>
<span><span class='co'># The Latent Mundlak Machine</span></span>
<span><span class='va'>mru</span> <span class='op'>&lt;-</span> <span class='fu'>ulam</span><span class='op'>(</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>alist</a></span><span class='op'>(</span></span>
<span>    <span class='co'># y model </span></span>
<span>    <span class='va'>Y</span> <span class='op'>~</span> <span class='fu'>normal</span><span class='op'>(</span><span class='va'>muY</span>, <span class='va'>sigmaY</span><span class='op'>)</span>,</span>
<span>    <span class='va'>muY</span> <span class='op'>&lt;-</span> <span class='va'>a</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>b_X</span><span class='op'>*</span><span class='va'>X</span> <span class='op'>+</span> <span class='va'>b_Z</span><span class='op'>*</span><span class='va'>Z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>+</span> <span class='va'>buy</span><span class='op'>*</span><span class='va'>u</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>transpars</span><span class='op'>&gt;</span> <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>a</span> <span class='op'>&lt;&lt;-</span> <span class='va'>abar</span> <span class='op'>+</span> <span class='va'>z</span><span class='op'>*</span><span class='va'>tau</span>,</span>
<span>    <span class='co'># X model</span></span>
<span>    <span class='va'>X</span> <span class='op'>~</span> <span class='fu'>bernoulli</span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>,</span>
<span>    <span class='fu'>logit</span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>aX</span> <span class='op'>+</span> <span class='va'>bux</span><span class='op'>*</span><span class='va'>u</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span>,</span>
<span>    <span class='va'>vector</span><span class='op'>[</span><span class='va'>Ng</span><span class='op'>]</span><span class='op'>:</span><span class='va'>u</span> <span class='op'>~</span> <span class='fu'>normal</span> <span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    </span>
<span>    <span class='co'># priors</span></span>
<span>    <span class='va'>z</span><span class='op'>[</span><span class='va'>g</span><span class='op'>]</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>aX</span>, <span class='va'>b_X</span>, <span class='va'>buy</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>bux</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>abar</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>dnorm</a></span> <span class='op'>(</span><span class='fl'>0</span>,<span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='va'>tau</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>sigma</span>, <span class='va'>sigmaY</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/Exponential.html'>dexp</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span>,</span>
<span>  data <span class='op'>=</span> <span class='va'>dat</span>, chains <span class='op'>=</span> <span class='fl'>4</span>, cores<span class='op'>=</span><span class='fl'>4</span>, sample<span class='op'>=</span><span class='cn'>TRUE</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>mru</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h4 id="brms-14">brms</h4>
<h5 id="brms-me-measurement-error-notation-2">brms me() measurement error notation</h5>
<p>I had to add .01 to the <code>Xse</code> because brms does not permit 0 measurement error (when modelling measurement error).</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_gr</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='fu'>me</span><span class='op'>(</span><span class='va'>Xbar</span>, <span class='va'>Xse</span>, gr <span class='op'>=</span> <span class='va'>id</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>Xse <span class='op'>=</span> <span class='va'>Xse</span> <span class='op'>+</span> <span class='fl'>0.01</span><span class='op'>)</span>, </span>
<span>             prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"meXbarXsegrEQid"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span><span class='op'>)</span>,</span>
<span>                 <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sdme"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
<h5 id="brms-mi-missingness-notation-2">brms mi() missingness notation</h5>
<p>brms does not support the mi() notation for binary variables. Also, it does not accept zero measurement error, so I averaged across groups to take the mean Xse.</p>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>b_mru_mi</span> <span class='op'>&lt;-</span> <span class='fu'>brm</span><span class='op'>(</span><span class='fu'>bf</span><span class='op'>(</span><span class='va'>Y</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>X</span> <span class='op'>+</span> <span class='va'>Z</span> <span class='op'>+</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>X2</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>             <span class='fu'>bf</span><span class='op'>(</span><span class='va'>X2</span> <span class='op'>|</span> <span class='fu'>mi</span><span class='op'>(</span><span class='va'>Xse</span><span class='op'>)</span> <span class='op'>~</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>id</span><span class='op'>)</span><span class='op'>)</span>, family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>sim</span> <span class='op'>%&gt;%</span> <span class='fu'>mutate</span><span class='op'>(</span>Xse <span class='op'>=</span> <span class='va'>Xse</span> <span class='op'>+</span> <span class='fl'>0.01</span><span class='op'>)</span>, iter <span class='op'>=</span> <span class='fl'>4000</span>,</span>
<span>            prior <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"X"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"Z"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"normal(0, 1)"</span>, class <span class='op'>=</span> <span class='st'>"b"</span>, coef <span class='op'>=</span> <span class='st'>"miX2"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"Y"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"exponential(1)"</span>, class <span class='op'>=</span> <span class='st'>"sd"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span>,</span>
<span>              <span class='fu'>set_prior</span><span class='op'>(</span><span class='st'>"constant(0.01)"</span>, class <span class='op'>=</span> <span class='st'>"sigma"</span>, resp <span class='op'>=</span> <span class='st'>"X2"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>b_mru_mi</span></span>
<span></span>
<span><span class='va'>b_mru_mi</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_Y_X</span>, <span class='va'>b_Y_Z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>mean_hdci</span><span class='op'>(</span><span class='op'>)</span></span></code></pre>
</div>
</details>
</div>
</details>
<h3 id="summary-2">Summary</h3>
<div class="layout-chunk" data-layout="l-body">
<details>
<summary>
Show code
</summary>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span></span>
<span>  brms_naive <span class='op'>=</span> <span class='va'>b_mn</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_fixed <span class='op'>=</span> <span class='va'>b_mf</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_multilevel <span class='op'>=</span> <span class='va'>b_mr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  brms_mundlak <span class='op'>=</span> <span class='va'>b_mrx</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>b_Xbar</span><span class='op'>)</span>,</span>
<span>  brms_mundlak_centered <span class='op'>=</span> <span class='va'>b_mrc</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span><span class='op'>)</span>,</span>
<span>  rethinking_latent_mundlak <span class='op'>=</span> <span class='va'>mru</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>buy</span><span class='op'>)</span>,</span>
<span>  brms_latent_mundlak <span class='op'>=</span> <span class='va'>b_mru_gr</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>bsp_meXbarXsegrEQid</span><span class='op'>)</span>,</span>
<span>  brms_latent_mundlak_mi <span class='op'>=</span> <span class='va'>b_mru_mi</span> <span class='op'>%&gt;%</span> <span class='fu'>gather_draws</span><span class='op'>(</span><span class='va'>b_Y_X</span>, <span class='va'>b_Y_Z</span>, <span class='va'>bsp_Y_miX2</span><span class='op'>)</span>,</span>
<span> .id <span class='op'>=</span> <span class='st'>"model"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>separate</span><span class='op'>(</span><span class='va'>model</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"package"</span>, <span class='st'>"model"</span><span class='op'>)</span>, extra <span class='op'>=</span> <span class='st'>"merge"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mutate</span><span class='op'>(</span>model <span class='op'>=</span> <span class='fu'>fct_inorder</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>model</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'>str_replace</span><span class='op'>(</span><span class='va'>.variable</span>, <span class='st'>"_Y"</span>, <span class='st'>""</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'>recode</span><span class='op'>(</span><span class='va'>.variable</span>, </span>
<span>                            <span class='st'>"buy"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span>,</span>
<span>                            <span class='st'>"bsp_miX2"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span>,</span>
<span>                            <span class='st'>"bsp_meXbarXsegrEQid"</span> <span class='op'>=</span> <span class='st'>"b_Xbar"</span><span class='op'>)</span>,</span>
<span>         .variable <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>.variable</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span></span>
<span><span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='va'>draws</span> <span class='op'>%&gt;%</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>package</span>, <span class='va'>model</span>, <span class='va'>.variable</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>mean_hdci</span><span class='op'>(</span>.width <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.95</span>, <span class='fl'>.99</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> </span>
<span>  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span></span>
<span></span>
<span><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>draws</span>, <span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>package</span>, x <span class='op'>=</span> <span class='va'>.value</span>, xmin <span class='op'>=</span> <span class='va'>.lower</span>, xmax <span class='op'>=</span> <span class='va'>.upper</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_pointinterval</span><span class='op'>(</span>position <span class='op'>=</span> <span class='fu'>position_dodge</span><span class='op'>(</span>width <span class='op'>=</span> <span class='fl'>.4</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>ggrepel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html'>geom_text_repel</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>label <span class='op'>=</span> <span class='fu'>if_else</span><span class='op'>(</span><span class='va'>.width</span> <span class='op'>==</span> <span class='fl'>.95</span>, <span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"%.2f"</span>, <span class='va'>.value</span><span class='op'>)</span>, <span class='cn'>NA_character_</span><span class='op'>)</span><span class='op'>)</span>, nudge_y <span class='op'>=</span> <span class='fl'>.1</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>geom_vline</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>true_val</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='st'>'dashed'</span>, data <span class='op'>=</span> <span class='fu'>tibble</span><span class='op'>(</span>true_val <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>b_X</span>, <span class='va'>b_Z</span>, <span class='va'>b_Ug</span> <span class='op'>-</span> <span class='va'>b_X</span><span class='op'>)</span>, .variable <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"b_X"</span>, <span class='st'>"b_Z"</span>, <span class='st'>"b_Xbar"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>  <span class='fu'>scale_color_discrete</span><span class='op'>(</span>breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>draws</span><span class='op'>$</span><span class='va'>model</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>facet_grid</span><span class='op'>(</span><span class='va'>model</span> <span class='op'>~</span> <span class='va'>.variable</span>, scales <span class='op'>=</span> <span class='st'>"free_x"</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>theme_bw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.99</span>,<span class='fl'>0.99</span><span class='op'>)</span>,</span>
<span>        legend.justification <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>,<span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
</details>
<div class="figure"><span style="display:block;" id="fig:biasgb"></span>
<img src="latent-group-mean-centering-revisited_files/figure-html5/biasgb-1.png" alt="Estimated coefficients and the true values (dashed line)" width="624" />
<p class="caption">
Figure 3: Estimated coefficients and the true values (dashed line)
</p>
</div>
</div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>the group here can be an individual measured several times, a sibling group, a school, a nation, etc.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Mundlak, Y. 1978: On the pooling of time series and cross section data. Econometrica 46:69-85.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>What McElreath calls Full Luxury Bayes: Latent Mundlak machine<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>I think the reason he thought it works is that in the data he used, from McNeish &amp; Hamaker 2020, the group mean varies very little except for measurement error, so we expect it not to make a difference.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
